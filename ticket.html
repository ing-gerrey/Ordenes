<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tickets ‚Äî Cocina</title>
<style>
  :root{
    --ok:#28a745;
    --out:#d9534f;
  }
  body{font-family:system-ui,Arial,sans-serif;background:#f7f9fb;margin:0;padding:16px;}
  h1{text-align:center;margin:8px 0;}
  #status{text-align:center;margin:8px 0;color:#667085;font-size:14px}
  #lista p{background:#fff;border:1px solid #e3e6ea;padding:10px;border-radius:10px;margin:8px 0}
  .pedido-listo{color:#1e7e34}
  .pedido-agotado{color:var(--out);text-decoration:line-through}
  button{margin-left:8px;padding:6px 10px;border:none;border-radius:8px;cursor:pointer;font-size:14px}
  .btn-listo{background:var(--ok);color:#fff}
  .btn-agotado{background:var(--out);color:#fff}
  .err{color:#c0392b}
</style>
</head>
<body>
  <h1>√ìrdenes registradas</h1>
  <div id="status">Cargando‚Ä¶</div>
  <div id="lista"></div>

  <script>
    // Muestra errores JS en pantalla (√∫til en m√≥vil)
    window.onerror = (msg)=>{ const s=document.getElementById('status'); s.innerHTML='‚ö†Ô∏è <b>Error:</b> '+msg; s.classList.add('err'); };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, onValue, query, orderByChild, update }
      from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const statusEl = document.getElementById('status');

    // ‚ö†Ô∏è Verifica que este databaseURL sea EXACTO al de tu consola
    const firebaseConfig = {
      apiKey: "AIzaSyDkzW3BnlnhDXf2naDEsjx-zouCQw1AJ9c",
      authDomain: "ordenes-b0c4c.firebaseapp.com",
      databaseURL: "https://ordenes-b0c4c-default-rtdb.firebaseio.com",
      projectId: "ordenes-b0c4c",
      storageBucket: "ordenes-b0c4c.appspot.com",
      messagingSenderId: "168920201545",
      appId: "1:168920201545:web:7a8e53c3e34e28e7508298",
      measurementId: "G-RSG46R8W8C"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    statusEl.textContent = '‚úÖ Firebase listo';

    const lista = document.getElementById("lista");

    function pintar(items){
      lista.innerHTML = "";
      if(items.length === 0){
        lista.innerHTML = "<p>No hay √≥rdenes a√∫n.</p>";
        return;
      }
      items.forEach(([key,o],i)=>{
        const p = document.createElement("p");
        let html = `${i+1}. <b>${o.nombre}</b> pidi√≥: <b>${o.opcion}</b> ${o.papas ? "ü•î (Con papas)":"‚ùå (Sin papas)"} ‚Äî ${o.fecha}`;

        if(!o.listo && !o.agotado){
          html += ` <button class="btn-listo" onclick="window._ok('${key}')">Listo</button>`;
          html += ` <button class="btn-agotado" onclick="window._out('${key}')">Agotado</button>`;
        }else if(o.listo && !o.agotado){
          html += " ‚úÖ Listo";
          p.classList.add("pedido-listo");
          html += ` <button class="btn-agotado" onclick="window._out('${key}')">Agotado</button>`;
        }else if(o.agotado){
          html += " üî¥ Agotado";
          p.classList.add("pedido-agotado");
        }

        p.innerHTML = html;
        lista.appendChild(p);
      });
    }

    // Suscripci√≥n en tiempo real a todas las √≥rdenes (orden por id ascendente)
    onValue(
      query(ref(db,"ordenes"), orderByChild("id")),
      (snap)=>{
        const data = snap.val() || {};
        const items = Object.entries(data).sort((a,b)=>a[1].id - b[1].id);
        pintar(items);
      },
      (e)=>{
        statusEl.innerHTML = '‚ö†Ô∏è <b>Error leyendo:</b> ' + (e?.message || e);
        statusEl.classList.add('err');
        console.error(e);
      }
    );

    // Acciones de los botones
    window._ok  = async (key)=>{
      try{ await update(ref(db,"ordenes/"+key), { listo:true  }); }
      catch(e){ alert('Error marcando listo: '+(e?.message||e)); }
    };
    window._out = async (key)=>{
      try{ await update(ref(db,"ordenes/"+key), { agotado:true }); }
      catch(e){ alert('Error marcando agotado: '+(e?.message||e)); }
    };
  </script>
</body>
</html>
