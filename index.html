<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S√°bado espeluznante 32 ‚Äî Ordenar</title>
<style>
  :root{
    --bg-dark:#0e1723;
    --card:#111a27cc;
    --accent:#7fffd4;
    --ok:#2ecc71;
    --warn:#e74c3c;
  }
  html,body{height:100%;}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:#e7f1ff; background:#0a1520;
    background-image:url('./Fondo1.jpg');
    background-size:cover; background-position:center; background-attachment:fixed;
  }
  @media (min-width:768px){
    body{ background-image:url('./Fondo2.jpg'); }
  }
  .wrap{min-height:100%; display:flex; flex-direction:column;}
  header{
    text-align:center; padding:18px 12px;
    background:linear-gradient(180deg,#0a1520 0%,#0a152000 100%);
  }
  header h1{
    margin:0; font-size:1.35rem; letter-spacing:.3px; font-weight:700;
    display:flex; align-items:center; justify-content:center; gap:.5rem;
  }
  .alien{font-size:1.3rem; filter:drop-shadow(0 0 4px #00ff95);}
  .sub{opacity:.85; font-size:.85rem; margin-top:6px}
  main{flex:1; padding:10px; max-width:720px; margin:0 auto;}
  .card{
    background:var(--card); backdrop-filter:blur(6px);
    border:1px solid #203146; border-radius:14px; padding:14px; margin-bottom:12px;
  }
  .row{display:flex; gap:10px; align-items:center;}
  .row > *{flex:1;}
  input[type="text"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3b53;
    background:#0c1a29; color:#fff; font-size:16px;
  }
  .lock{font-size:.9rem; opacity:.8; margin-top:6px}
  .grid{
    display:grid; gap:10px; grid-template-columns:repeat(3,1fr);
  }
  .opt{
    border-radius:12px; overflow:hidden; border:1px solid #203146; background:#0c1a29;
  }
  .opt img{display:block; width:100%; height:90px; object-fit:cover;}
  .opt button{
    width:100%; border:0; background:#12253a; color:#e7f1ff; padding:8px; cursor:pointer;
    font-weight:600;
  }
  .opt button:disabled{opacity:.35; cursor:not-allowed;}
  .actions{display:flex; gap:10px;}
  .btn{
    flex:1; padding:10px 12px; border-radius:10px; border:1px solid #2a3b53;
    background:#12253a; color:#fff; font-weight:700; cursor:pointer;
  }
  .btn.ok{background:#133825; border-color:#1d6b3f;}
  .btn.warn{background:#3a1416; border-color:#6b1d23;}
  .mute{opacity:.65}
  .status{margin-top:6px; font-size:.9rem}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.78rem; border:1px solid #2a3b53; background:#0c1a29}
  ul{list-style:none; padding:0; margin:8px 0 0}
  li{padding:6px 0; border-bottom:1px dashed #203146;}
  footer{padding:16px; text-align:center; font-size:.8rem; opacity:.85}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><span class="alien">üëΩ</span> S√°bado espeluznante 32 ‚Äî Hotdogs</h1>
    <div class="sub">Para Yuli ‚Ä¢ ¬© Evento Especial ‚Äî Inspirado en una noche pixelada</div>
  </header>

  <main>
    <section class="card">
      <label for="nombre">Tu nombre</label>
      <div class="row" style="margin-top:6px">
        <input id="nombre" type="text" placeholder="Escribe tu nombre‚Ä¶" />
      </div>
      <div id="lockMsg" class="lock" hidden>üîí El nombre queda fijo despu√©s de tu primera orden.</div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
        <strong>Elige tu hotdog</strong>
        <span class="tag">Sencillo ‚Ä¢ Cebolla caramelizada ‚Ä¢ Chili</span>
      </div>
      <div id="opciones" class="grid">
        <div class="opt">
          <img src="./opcion1.jpg" alt="Sencillo">
          <button data-opcion="Sencillo">Sencillo</button>
        </div>
        <div class="opt">
          <img src="./opcion2.jpg" alt="Cebolla caramelizada">
          <button data-opcion="Cebolla caramelizada">Cebolla caramelizada</button>
        </div>
        <div class="opt">
          <img src="./opcion3.jpg" alt="Chili">
          <button data-opcion="Chili">Chili</button>
        </div>
      </div>
      <div id="selStatus" class="status"></div>
    </section>

    <section class="card">
      <div class="actions">
        <button id="btnNueva" class="btn ok" disabled>Nueva orden</button>
        <button id="btnCancelar" class="btn warn" disabled>Cancelar orden</button>
      </div>
      <div id="info" class="status"></div>
    </section>

    <section class="card">
      <strong>Historial de mis √≥rdenes</strong>
      <ul id="historial"></ul>
    </section>
  </main>

  <footer>Hecho con Firebase ‚Ä¢ GitHub Pages</footer>
</div>

<!-- Firebase + Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    onSnapshot, query, where, orderBy, doc, getDocs, updateDoc, deleteDoc, limit
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // === TU CONFIG (usa la tuya; esta es la que nos mostraste) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDkzW3BnlnhDXf2naDEsjx-zouCQw1AJ9c",
    authDomain: "ordenes-b0c4c.firebaseapp.com",
    projectId: "ordenes-b0c4c",
    storageBucket: "ordenes-b0c4c.appspot.com",
    messagingSenderId: "168920201545",
    appId: "1:168920201545:web:7a8e53c3e34e28e7508298",
    measurementId: "G-RSG46R8W8C"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ======= UI refs
  const $nombre = document.getElementById('nombre');
  const $lockMsg = document.getElementById('lockMsg');
  const $opciones = document.getElementById('opciones');
  const $selStatus = document.getElementById('selStatus');
  const $btnNueva = document.getElementById('btnNueva');
  const $btnCancelar = document.getElementById('btnCancelar');
  const $info = document.getElementById('info');
  const $historial = document.getElementById('historial');

  const ORD_COL = collection(db, 'ordenes');

  // Persistir nombre en localStorage para UX
  const storedName = localStorage.getItem('nombre');
  if (storedName) {
    $nombre.value = storedName;
    lockNameIfNeeded();
    suscribirHistorial(storedName);
  }

  // Bloquea nombre despu√©s de la primera orden (marcamos flag en Firestore por usuario con existencia de docs)
  async function lockNameIfNeeded() {
    const n = $nombre.value.trim();
    if (!n) return;
    const snap = await getDocs(query(ORD_COL, where('nombre','==', n), limit(1)));
    const locked = !snap.empty;
    toggleNameLocked(locked);
    if (locked) suscribirHistorial(n);
  }

  function toggleNameLocked(locked){
    $nombre.readOnly = locked;
    $lockMsg.hidden = !locked;
  }

  // Al cambiar nombre manualmente
  $nombre.addEventListener('change', () => {
    const n = $nombre.value.trim();
    localStorage.setItem('nombre', n);
    suscribirHistorial(n);
    lockNameIfNeeded();
  });

  // Suscripci√≥n al historial de este usuario
  let unsubHist = null;
  function suscribirHistorial(nombre){
    if (unsubHist) { unsubHist(); unsubHist=null; }
    if (!nombre) { $historial.innerHTML=''; return; }
    const q = query(ORD_COL, where('nombre','==', nombre), orderBy('fecha','desc'));
    unsubHist = onSnapshot(q, (snap)=>{
      $historial.innerHTML = '';
      if (snap.empty){ $historial.innerHTML = '<li class="mute">Sin √≥rdenes</li>'; return; }
      snap.forEach(docu=>{
        const d = docu.data();
        const estado = d.estado || 'pendiente';
        const papas = d.papas ? 'üçü' : '‚Äî';
        const line = document.createElement('li');
        line.innerHTML = `<strong>${d.opcion}</strong> ${papas} <span class="tag">${estado}</span> <span class="mute">‚Ä¢ ${d.nombre}</span>`;
        $historial.appendChild(line);
      });
    });
  }

  // Click en opciones
  $opciones.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-opcion]');
    if (!btn) return;
    const nombre = $nombre.value.trim();
    if (!nombre){
      alert('Por favor, escribe tu nombre antes de pedir.');
      $nombre.focus();
      return;
    }
    // Confirm de papas: Aceptar = S√≠, Cancelar = No
    const conPapas = confirm('¬øQuieres papas? (Aceptar = S√≠, Cancelar = No)');
    $selStatus.textContent = `Seleccionaste: ${btn.dataset.opcion}${conPapas?' + papas':''}.`;

    // Guardar orden en Firestore
    try{
      await addDoc(ORD_COL, {
        nombre,
        opcion: btn.dataset.opcion,
        papas: conPapas,
        fecha: serverTimestamp(),
        estado: 'pendiente'
      });
      localStorage.setItem('nombre', nombre);
      $info.textContent = '‚úÖ Orden enviada. ¬°Gracias!';
      $btnNueva.disabled = false;
      $btnCancelar.disabled = false;
      toggleNameLocked(true);
      suscribirHistorial(nombre);
    }catch(err){
      $info.textContent = '‚ö†Ô∏è Error al guardar: ' + err.message;
    }
  });

  // Nueva orden: solo re-habilita selecci√≥n visualmente
  $btnNueva.addEventListener('click', ()=>{
    $selStatus.textContent = 'Puedes elegir otra opci√≥n.';
  });

  // Cancelar: borra la √∫ltima orden pendiente de este usuario
  $btnCancelar.addEventListener('click', async ()=>{
    const nombre = $nombre.value.trim();
    if (!nombre) return;
    try{
      const snap = await getDocs(query(ORD_COL,
        where('nombre','==', nombre),
        where('estado','==','pendiente'),
        orderBy('fecha','desc'),
        limit(1)
      ));
      if (snap.empty){ $info.textContent='No hay orden pendiente para cancelar.'; return; }
      const d = snap.docs[0];
      await deleteDoc(doc(db,'ordenes', d.id));
      $info.textContent = 'üóëÔ∏è Orden cancelada.';
    }catch(err){
      $info.textContent = '‚ö†Ô∏è Error al cancelar: ' + err.message;
    }
  });

  // Primera carga: si hay nombre, bloquea si ya tiene orden previa
  lockNameIfNeeded();
</script>
</body>
</html>
